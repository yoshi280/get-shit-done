---
phase: 01-selectable-research-dimensions-observability
plan: 02
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - ~/.claude/get-shit-done/workflows/plan-phase.md
  - ~/.claude/agents/gsd-phase-researcher.md
autonomous: true
requirements:
  - DIM-01
  - DIM-02
  - DIM-03
  - OBS-01

must_haves:
  truths:
    - "User sees a dimension checklist during /gsd:plan-phase with pre-selected dimensions based on project type and phase goal"
    - "User can toggle dimensions on/off in the checklist"
    - "User can add a custom dimension via 'Other' option"
    - "User is offered the chance to customize dimension prompts before research begins"
    - "Custom dimensions are saved to .planning/dimensions/{slug}.md"
    - "Researcher receives only the selected dimensions (not all 9)"
    - "Researcher writes a <token_report> footer into RESEARCH.md after completing research"
    - "plan-phase.md displays per-dimension token usage after researcher returns"
  artifacts:
    - path: "~/.claude/get-shit-done/workflows/plan-phase.md"
      provides: "Dimension selection flow (Steps 5.1-5.5) and live token display"
      contains: "Dimensions"
    - path: "~/.claude/agents/gsd-phase-researcher.md"
      provides: "Parameterized dimension support and token_report footer writing"
      contains: "token_report"
  key_links:
    - from: "~/.claude/get-shit-done/workflows/plan-phase.md"
      to: "~/.claude/get-shit-done/dimensions/*.md"
      via: "ls and frontmatter parsing to build checklist"
      pattern: "dimensions/\\*\\.md"
    - from: "~/.claude/get-shit-done/workflows/plan-phase.md"
      to: "~/.claude/agents/gsd-phase-researcher.md"
      via: "Task() spawn with selected dimensions injected into prompt"
      pattern: "Task\\("
    - from: "~/.claude/agents/gsd-phase-researcher.md"
      to: "RESEARCH.md"
      via: "Writes token_report footer after research"
      pattern: "token_report"
    - from: "~/.claude/get-shit-done/workflows/plan-phase.md"
      to: ".planning/dimensions/"
      via: "Saves custom dimensions from 'Other' option"
      pattern: "\\.planning/dimensions/"
---

<objective>
Implement the dimension selection flow in plan-phase.md and parameterize the researcher agent to accept dynamic dimensions with token self-reporting.

Purpose: This is the core user-facing feature -- the ability to choose which research dimensions run. It replaces the fixed 4-dimension pipeline with a flexible, user-editable set. The token self-reporting enables the cost tracking built in Plan 03.

Output: Modified plan-phase.md with dimension selection (Steps 5.1-5.5) and modified gsd-phase-researcher.md with parameterized dimensions and token_report writing.
</objective>

<execution_context>
@/Users/thelorax/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thelorax/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-selectable-research-dimensions-observability/01-RESEARCH.md
@.planning/phases/01-selectable-research-dimensions-observability/01-01-SUMMARY.md
@~/.claude/get-shit-done/workflows/plan-phase.md
@~/.claude/agents/gsd-phase-researcher.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dimension selection flow to plan-phase.md</name>
  <files>~/.claude/get-shit-done/workflows/plan-phase.md</files>
  <action>
    Modify the plan-phase.md workflow to insert a dimension selection block BEFORE the researcher is spawned (between current Steps 4 and 5). The existing Step 5 "Handle Research" should be restructured to include the new sub-steps. The rest of the workflow remains unchanged.

    Insert these sub-steps into Step 5, before the "Spawn gsd-phase-researcher" section:

    **Step 5.1: Load Dimension Catalog**

    Add bash to load dimension files:
    ```
    # Load global dims
    GLOBAL_DIMS=$(ls ~/.claude/get-shit-done/dimensions/*.md 2>/dev/null)
    # Load project dims (if any)
    PROJECT_DIMS=$(ls .planning/dimensions/*.md 2>/dev/null)
    ```

    For each .md file, extract frontmatter fields `name` and `short_description`. Project dims override global dims on name collision (compare by `name` field). Build a combined list of available dimensions.

    **Step 5.2: Infer Relevant Dimensions**

    Claude analyzes PROJECT.md project type and current phase goal from ROADMAP.md to pre-select dimensions. Document the default inference rules:
    - web-app: stack, features, architecture, pitfalls, security-compliance
    - cli: stack, architecture, pitfalls, best-practices
    - library: stack, architecture, best-practices, testing-strategies
    - api/service: stack, architecture, pitfalls, security-compliance, data-structures
    - mobile: stack, features, architecture, pitfalls, security-compliance
    - fallback (unknown type): stack, features, architecture, pitfalls

    **Step 5.3: Present Checklist**

    Use AskUserQuestion with:
    - header: "Dimensions" (10 chars, under 12-char limit per Pitfall 2)
    - question: "Which dimensions should the researcher cover for Phase {N}?\nClaude pre-selected based on project type ({type}) and phase goal."
    - options: One per dimension formatted as "{name} -- {short_description}" with pre-selected ones marked. Include "Other -- add a custom dimension" as last option.
    - Allow multi-select; user toggles on/off.

    **Step 5.4: Handle "Other"**

    If user selects "Other":
    - Ask: "Name for this dimension?" (generates kebab-case slug)
    - Ask: "Brief description -- what should the researcher investigate?"
    - Claude expands the brief description into a full research prompt (10-15 lines)
    - Check for name collision with globals per Pitfall 3: if collision, ask user "This matches an existing dimension '{name}'. Override it (global won't run) or use a different name?"
    - Write to .planning/dimensions/{slug}.md with full frontmatter
    - Add to selected set

    **Step 5.5: Offer Prompt Editing**

    Use AskUserQuestion:
    - header: "Customize?" (10 chars, under 12-char limit)
    - question: "Customize any dimension prompt before researching? (optional)"
    - options: list selected dimension names + "No -- research as configured"
    - If user selects a dimension: show current prompt, allow free text replacement or targeted edits. Save edits to .planning/dimensions/{name}.md (project override).

    **Modify the researcher spawn to inject selected dimensions:**

    Update the existing research prompt template to include the selected dimensions. Add a `<selected_dimensions>` section to the prompt that lists each selected dimension's name and full research prompt body. The researcher will use ONLY these dimensions (not hardcoded ones).

    **Add live token display after researcher returns:**

    After the researcher Task() returns, parse the `<token_report>` from the resulting RESEARCH.md:
    ```
    # After researcher returns, read token report
    TOKEN_REPORT=$(grep -A 7 "<token_report>" "${PHASE_DIR}/${PADDED_PHASE}-RESEARCH.md" 2>/dev/null)
    ```

    Display formatted output:
    ```
    Research complete
      Dimensions: {comma-separated list}
      Input: {N} tokens  Output: {N} tokens
      Estimated cost: ~${X.XX} ({model})
    ```

    Per locked decision: this is one of three display locations (live output after researcher finishes).

    IMPORTANT: Do NOT modify steps 1-4 or steps 6-14 of plan-phase.md. Only modify Step 5 (Handle Research). Preserve all existing skip conditions (--gaps, --skip-research, research_enabled=false).
  </action>
  <verify>
    Read the modified plan-phase.md and verify:
    1. Steps 5.1 through 5.5 exist with dimension loading, inference, checklist, custom handling, and prompt editing
    2. AskUserQuestion headers are 12 chars or fewer ("Dimensions" = 10, "Customize?" = 10)
    3. The researcher spawn prompt includes a <selected_dimensions> section
    4. Token display code exists after the researcher Task() return handling
    5. Steps 1-4 and 6-14 are unchanged
    6. All existing skip conditions (--gaps, --skip-research, etc.) are preserved
  </verify>
  <done>plan-phase.md contains dimension selection sub-steps (5.1-5.5) that load the catalog, infer defaults, present a checklist via AskUserQuestion, handle custom dimensions, offer prompt editing, inject selected dimensions into the researcher prompt, and display live token usage after research completes.</done>
</task>

<task type="auto">
  <name>Task 2: Parameterize researcher agent for dynamic dimensions and token reporting</name>
  <files>~/.claude/agents/gsd-phase-researcher.md</files>
  <action>
    Modify gsd-phase-researcher.md to:

    1. **Accept parameterized dimensions from the orchestrator.**

    Add a new `<dimension_input>` section to the agent's documentation that explains the researcher now receives a `<selected_dimensions>` block in its prompt. Each dimension includes name and full research prompt text. The researcher should execute research for EACH selected dimension (not just the hardcoded 4).

    Update Step 2 (Identify Research Domains) to say: "Use the `<selected_dimensions>` from the orchestrator prompt. If no `<selected_dimensions>` block is present (backward compatibility), fall back to the 4 default dimensions: stack, features, architecture, pitfalls."

    Update Step 3 (Execute Research Protocol) to iterate over selected dimensions.

    Update the RESEARCH.md output format to support variable dimension sections. Each selected dimension gets its own `## {Dimension Name}` section in RESEARCH.md. The existing section names (## Standard Stack, ## Architecture Patterns, ## Common Pitfalls, etc.) map to the legacy 4 dimensions. New dimensions use their `name` as the section header (e.g., `## Best Practices`, `## Security & Compliance`).

    2. **Write a `<token_report>` footer into RESEARCH.md.**

    Add to Step 5 (Write RESEARCH.md): after writing all research content, append a `<token_report>` block at the very bottom of the file (after all existing sections, per Pitfall 5 -- do not change RESEARCH.md main body structure).

    The token_report format:
    ```
    <token_report>
    dimensions: {comma-separated selected dimension names}
    model: {the model this researcher is running as, from context}
    input_tokens: {estimated input tokens for this research session}
    output_tokens: {estimated output tokens for this research session}
    estimated_cost_usd: {calculated from token counts and price-per-token}
    note: estimated from session context; actual may vary +/-20%
    </token_report>
    ```

    The researcher should:
    - Read .planning/config.json to get token_prices for its model (if available)
    - If token_prices not available, use hardcoded defaults: sonnet at $3/$15 per MTok
    - Estimate its own token usage from its context window consumption
    - Calculate cost as: (input_tokens * input_per_mtok / 1_000_000) + (output_tokens * output_per_mtok / 1_000_000)
    - Label all costs as "estimated" (per Pitfall 4 -- never claim exact costs)

    3. **Preserve backward compatibility.**

    The existing RESEARCH.md format (user_constraints, phase_requirements, standard_stack, architecture_patterns, etc.) MUST remain intact. The token_report goes at the very end. The planner reads RESEARCH.md sections by name and ignores unknown tags.

    Do NOT change the existing output_format section structure. Only ADD the token_report instruction and the dimension parameterization.

    Do NOT modify the <role>, <upstream_input>, <downstream_consumer>, <philosophy>, <tool_strategy>, <source_hierarchy>, or <verification_protocol> sections. Only modify <execution_flow> and <output_format>.
  </action>
  <verify>
    Read the modified gsd-phase-researcher.md and verify:
    1. A <dimension_input> section or equivalent documentation exists explaining parameterized dimensions
    2. Step 2 references <selected_dimensions> with backward-compatible fallback
    3. The RESEARCH.md output format includes the <token_report> footer specification
    4. The token_report includes dimensions, model, input_tokens, output_tokens, estimated_cost_usd, note
    5. Existing sections (<role>, <upstream_input>, <downstream_consumer>, <philosophy>, etc.) are unchanged
    6. The RESEARCH.md main body structure (user_constraints, phase_requirements, summary, etc.) is preserved
  </verify>
  <done>gsd-phase-researcher.md accepts parameterized dimensions via <selected_dimensions> in the orchestrator prompt, iterates over them for research, writes variable-section RESEARCH.md, and appends a <token_report> footer with self-estimated token usage and cost.</done>
</task>

</tasks>

<verification>
1. plan-phase.md has dimension selection flow (5.1-5.5) that loads global+project dims, infers defaults, presents checklist, handles custom dims, offers prompt editing
2. AskUserQuestion headers are within the 12-char limit
3. plan-phase.md injects selected dimensions into researcher prompt
4. plan-phase.md displays live token usage after researcher returns
5. gsd-phase-researcher.md accepts parameterized dimensions with backward-compatible fallback
6. gsd-phase-researcher.md writes <token_report> footer to RESEARCH.md
7. No changes to plan-phase.md steps outside Step 5
8. No changes to researcher sections outside execution_flow and output_format
</verification>

<success_criteria>
- Dimension selection flow exists in plan-phase.md (DIM-01: add, DIM-02: remove, DIM-03: edit prompts)
- Researcher accepts dynamic dimensions and self-reports token usage (OBS-01)
- Backward compatibility preserved for both plan-phase.md and researcher agent
- The system works end-to-end: user sees checklist, selects/edits dims, researcher runs selected dims, token report written
</success_criteria>

<output>
After completion, create `.planning/phases/01-selectable-research-dimensions-observability/01-02-SUMMARY.md`
</output>
