---
phase: 01-selectable-research-dimensions-observability
plan: 03
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - ~/.claude/get-shit-done/bin/gsd-tools.cjs
  - ~/.claude/get-shit-done/templates/state.md
  - ~/.claude/get-shit-done/workflows/progress.md
  - .planning/config.json
autonomous: true
requirements:
  - OBS-02
  - OBS-03

must_haves:
  truths:
    - "gsd-tools.cjs has a 'state update-cost' subcommand that writes phase cost data to STATE.md"
    - "STATE.md has a ## Cost Tracker section with per-phase rows and cumulative total"
    - "Cost Tracker table is capped at 10 most recent phases to respect STATE.md size constraint"
    - "config.json has a token_prices section with per-model input/output rates"
    - "/gsd:progress displays a cost summary section reading from STATE.md Cost Tracker"
    - "All costs are labeled as 'estimated' in display"
  artifacts:
    - path: "~/.claude/get-shit-done/bin/gsd-tools.cjs"
      provides: "state update-cost subcommand"
      contains: "update-cost"
    - path: "~/.claude/get-shit-done/templates/state.md"
      provides: "Cost Tracker section template"
      contains: "Cost Tracker"
    - path: "~/.claude/get-shit-done/workflows/progress.md"
      provides: "Cost summary display section"
      contains: "Cost Summary"
    - path: ".planning/config.json"
      provides: "token_prices configuration"
      contains: "token_prices"
  key_links:
    - from: "~/.claude/get-shit-done/workflows/plan-phase.md"
      to: "~/.claude/get-shit-done/bin/gsd-tools.cjs"
      via: "Calls state update-cost after researcher completes"
      pattern: "state update-cost"
    - from: "~/.claude/get-shit-done/bin/gsd-tools.cjs"
      to: ".planning/STATE.md"
      via: "Writes Cost Tracker rows and recalculates total"
      pattern: "Cost Tracker"
    - from: "~/.claude/get-shit-done/workflows/progress.md"
      to: ".planning/STATE.md"
      via: "Reads Cost Tracker section for display"
      pattern: "Cost Tracker"
    - from: "~/.claude/agents/gsd-phase-researcher.md"
      to: ".planning/config.json"
      via: "Reads token_prices for cost calculation"
      pattern: "token_prices"
---

<objective>
Implement the observability backend: token price configuration, cost tracking command in gsd-tools.cjs, STATE.md Cost Tracker section, and cost summary in progress reports.

Purpose: This is the data pipeline that makes research costs visible. The researcher (Plan 02) writes token_report footers; this plan builds everything that reads, stores, and displays that data. Together they fulfill the "informed, not anxious" cost visibility goal.

Output: gsd-tools.cjs state update-cost command, STATE.md Cost Tracker section, config.json token_prices, progress.md cost summary display.
</objective>

<execution_context>
@/Users/thelorax/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thelorax/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-selectable-research-dimensions-observability/01-RESEARCH.md
@~/.claude/get-shit-done/bin/gsd-tools.cjs
@~/.claude/get-shit-done/templates/state.md
@~/.claude/get-shit-done/workflows/progress.md
@.planning/config.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add token_prices to config.json and Cost Tracker to STATE.md template</name>
  <files>
    .planning/config.json
    ~/.claude/get-shit-done/templates/state.md
  </files>
  <action>
    **1. Update .planning/config.json** to add a `token_prices` section with current model pricing.

    Add to the existing config.json object:
    ```json
    "token_prices": {
      "claude-opus-4-6":   { "input_per_mtok": 5.00,  "output_per_mtok": 25.00 },
      "claude-opus-4-5":   { "input_per_mtok": 5.00,  "output_per_mtok": 25.00 },
      "claude-sonnet-4-5": { "input_per_mtok": 3.00,  "output_per_mtok": 15.00 },
      "claude-haiku-4-5":  { "input_per_mtok": 1.00,  "output_per_mtok": 5.00  }
    }
    ```

    Read the existing config.json first, add the token_prices key, and write back. Preserve all existing fields (mode, depth, parallelization, commit_docs, model_profile, workflow). Keep 2-space JSON indentation per codebase convention.

    **2. Update ~/.claude/get-shit-done/templates/state.md** to include a `## Cost Tracker` section.

    Add the Cost Tracker section to the file template (between ## Performance Metrics and ## Accumulated Context). The section template:

    ```markdown
    ## Cost Tracker

    **Total project cost:** $0.00 (estimated)
    **Last updated:** [date]

    | Phase | Dimensions Run | Input Tokens | Output Tokens | Cost (est.) |
    |-------|---------------|-------------|--------------|-------------|
    | - | - | - | - | - |
    ```

    Also add Cost Tracker documentation to the `<sections>` block explaining:
    - Tracks per-phase research token usage and estimated cost
    - Updated via `gsd-tools.cjs state update-cost` after each research phase
    - Table capped at 10 most recent phases (per Pitfall 6 -- STATE.md must stay under 100 lines)
    - Total always shows running cumulative even when old rows are pruned

    Also add a note in the `<size_constraint>` section that Cost Tracker rows are auto-pruned at 10.
  </action>
  <verify>
    Run: node -e "const c = JSON.parse(require('fs').readFileSync('.planning/config.json','utf8')); console.log(JSON.stringify(c.token_prices))"
    Expected: JSON with claude-opus-4-6, claude-sonnet-4-5, claude-haiku-4-5 entries.
    Read ~/.claude/get-shit-done/templates/state.md and verify "## Cost Tracker" section exists in the template.
  </verify>
  <done>config.json contains token_prices with current Anthropic model pricing. STATE.md template contains a ## Cost Tracker section with table format and auto-pruning documentation.</done>
</task>

<task type="auto">
  <name>Task 2: Add state update-cost command to gsd-tools.cjs</name>
  <files>~/.claude/get-shit-done/bin/gsd-tools.cjs</files>
  <action>
    Add a new `state update-cost` subcommand to gsd-tools.cjs. This command updates the ## Cost Tracker section in STATE.md.

    **Command signature:**
    ```
    state update-cost --phase N --dimensions "stack,architecture" --input-tokens 42000 --output-tokens 8500 --cost 0.25
    ```

    **Parameters:**
    - `--phase`: Phase number (e.g., "1", "2.1")
    - `--dimensions`: Comma-separated list of dimension names that were run
    - `--input-tokens`: Total input tokens (integer)
    - `--output-tokens`: Total output tokens (integer)
    - `--cost`: Estimated cost in USD (float)

    **Implementation:**

    1. Read STATE.md content
    2. Find the `## Cost Tracker` section. If it doesn't exist, create it with the template format.
    3. Parse the existing table rows (skip header and separator lines)
    4. Format token numbers with commas (e.g., 42,000)
    5. Format cost as $X.XXX (three decimal places)
    6. Add a new row: `| {phase} | {dimensions} | {input_tokens} | {output_tokens} | ${cost} |`
    7. If table has more than 10 data rows, remove the oldest rows (keep newest 10)
    8. Update the "Total project cost" line: sum all cost values in the table rows plus any previously pruned amount. Track the pruned total in a comment line `<!-- pruned_total: X.XX -->` above the table.
    9. Update the "Last updated" date to today
    10. Write STATE.md back

    **Follow existing gsd-tools.cjs conventions:**
    - Add the command handler function following the `cmdState*` naming pattern: `cmdStateUpdateCost(cwd, options, raw)`
    - Parse options from args array using the existing pattern (see cmdStateRecordMetric for reference)
    - Add the case to the `state` subcommand switch: `case 'update-cost': cmdStateUpdateCost(cwd, parseOptions, raw); break;`
    - Use `safeReadFile` and `fs.writeFileSync` per existing patterns
    - Return JSON result via `output()` function: `{ success: true, phase, cost, total_cost }`
    - On error, use the `error()` function pattern

    **Edge cases:**
    - STATE.md doesn't have Cost Tracker section yet: create it
    - Table has placeholder row (single dash row): replace it
    - Phase already has a row: add new row (don't replace -- a phase can have multiple research runs)

    Also add the command to the help text comment block at the top of gsd-tools.cjs (the usage/commands listing).
  </action>
  <verify>
    Test the command:
    Run: node ~/.claude/get-shit-done/bin/gsd-tools.cjs state update-cost --phase 1 --dimensions "stack,architecture,pitfalls" --input-tokens 42000 --output-tokens 8500 --cost 0.251
    Expected: JSON output with success: true.
    Then verify STATE.md:
    Run: grep -A 10 "Cost Tracker" .planning/STATE.md
    Expected: Table with one data row showing phase 1, the dimensions, token counts, and $0.251.
    Verify total is updated:
    Run: grep "Total project cost" .planning/STATE.md
    Expected: Contains "$0.251"
  </verify>
  <done>gsd-tools.cjs has a working `state update-cost` subcommand that writes cost data to STATE.md, formats numbers properly, caps the table at 10 rows, and maintains a running total.</done>
</task>

<task type="auto">
  <name>Task 3: Add cost summary to progress.md workflow</name>
  <files>~/.claude/get-shit-done/workflows/progress.md</files>
  <action>
    Modify the progress.md workflow to include a cost summary section in the progress report.

    Per the locked decision: "per-phase aggregates in /gsd:progress"

    **In the `<step name="report">` section**, add a new sub-section after the existing report structure. The cost summary should appear between "## Key Decisions Made" and "## Blockers/Concerns" (or after "## Pending Todos" if that's more natural for the flow).

    Add this to the report template:

    ```
    ## Cost Summary

    **Project cost to date:** {total from Cost Tracker} (estimated research tokens)

    | Phase | Cost | Dimensions |
    |-------|------|-----------|
    | {phase_name} | {cost} | {dimensions} |
    ...

    *Costs are estimates based on self-reported token usage. Actual API billing may differ.*
    ```

    **Implementation in the workflow:**

    1. Read the Cost Tracker section from STATE.md (already available via `state_content` from init)
    2. Parse the total project cost line
    3. Parse the table rows to build the per-phase cost summary
    4. If Cost Tracker section doesn't exist or has no data rows, skip the Cost Summary section entirely (don't show an empty table)
    5. Format the display with the "informed, not anxious" tone: use "estimated" language, include the disclaimer footnote

    **Tone guidance (from locked specifics):** "Cost reporting should make the user feel informed, not anxious -- present data without judgment." Do not use warning symbols, red text indicators, or language suggesting costs are high/concerning. Simply present the data.

    Do NOT modify the init_context, load, analyze_roadmap, recent, or position steps. Only modify the report step to add the cost display, and only if data exists.
  </action>
  <verify>
    Read the modified progress.md and verify:
    1. A "## Cost Summary" section template exists in the report step
    2. It reads from STATE.md Cost Tracker data
    3. It includes the "estimated" disclaimer
    4. It skips display when no cost data exists
    5. No other steps are modified
    6. Tone is informational, not judgmental
  </verify>
  <done>progress.md displays a cost summary section with per-phase cost breakdown and total project cost, reading from STATE.md Cost Tracker. Costs are labeled as estimates. Section is omitted when no data exists.</done>
</task>

</tasks>

<verification>
1. config.json has token_prices with correct model pricing
2. STATE.md template has ## Cost Tracker section with table format
3. gsd-tools.cjs state update-cost works: accepts args, writes to STATE.md, maintains running total
4. Cost Tracker table respects 10-row cap
5. progress.md shows cost summary from STATE.md data
6. progress.md omits cost summary when no data exists
7. All cost displays use "estimated" language
</verification>

<success_criteria>
- Token usage tracked per phase execution via gsd-tools.cjs (OBS-02)
- Cost summary displayed in progress reports (OBS-03)
- Configurable price-per-token in config.json
- Cumulative project-wide cost tracker in STATE.md
- All displays are "informed, not anxious" -- data without judgment
</success_criteria>

<output>
After completion, create `.planning/phases/01-selectable-research-dimensions-observability/01-03-SUMMARY.md`
</output>
